{% load static %}
{% include 'Dashboard/header.html' %}

<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center rounded-top-4">
      <h4 class="mb-0"><i class="bi bi-wallet-fill me-2"></i>Payment History</h4>
      <a href="{% url 'Dashboard' %}" class="btn btn-light btn-sm">← Back to Dashboard</a>
    </div>

    <!-- Filter + Export Section -->
    <form method="get" class="px-3 pt-3 d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <label for="status" class="form-label mb-0 me-2 fw-semibold">Filter Status:</label>
        <select name="status" id="status" class="form-select form-select-sm">
          <option value="">All</option>
          <option value="success" {% if status_filter == 'success' %}selected{% endif %}>Success</option>
          <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
          <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
        </select>
        <button type="submit" class="btn btn-sm btn-outline-primary">Apply</button>
      </div>

      <div>
        <a href="?{% if status_filter %}status={{ status_filter }}&{% endif %}export=csv" class="btn btn-sm btn-success">
          <i class="bi bi-download me-1"></i> Download CSV
        </a>
      </div>
    </form>

    <!-- Table -->
    <div class="card-body p-0">
      {% if all_payments %}
        {% if is_admin %}
          <div class="alert alert-info rounded-0 mb-0">You are viewing all <strong>{{ payment_count }}</strong> payment(s).</div>
        {% elif is_client %}
          <div class="alert alert-info rounded-0 mb-0">You are viewing your <strong>{{ payment_count }}</strong> payment(s).</div>
        {% endif %}

        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Amount</th>
                {% if is_admin %}
                <th>User</th>
                {% endif %}
                <th>Status</th>
                <th>Reference</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in all_payments %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="text-success fw-bold">₦{{ payment.amount|floatformat:2 }}</td>
                {% if is_admin %}
                <td>{{ payment.user|default:"-" }}</td>
                {% endif %}
                <td>
                  {% if payment.status == 'success' %}
                    <span class="badge bg-success">Success</span>
                  {% elif payment.status == 'Pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% else %}
                    <span class="badge bg-danger">Failed</span>
                  {% endif %}
                </td>
                <td class="small text-muted">{{ payment.reference|default:"N/A" }}</td>
                <td>{{ payment.created_at|date:"M d, Y h:i A" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-exclamation-circle fs-1 mb-3"></i>
          <p>No payment history available yet.</p>
        </div>
      {% endif %}
    </div>

    <div class="card-footer text-end bg-white">
      <small class="text-muted">Total Payments: {{ payment_count }}</small>
    </div>
  </div>
</div>

{% include 'Dashboard/footer.html' %}
